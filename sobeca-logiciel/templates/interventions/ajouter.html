{% extends 'layout.html' %}

{% block title %}Ordre de travail{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-tools me-2"></i>Ordre de travail</h1>
    <a href="{{ url_for('liste_interventions') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i>Retour à la liste
    </a>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <form method="post" action="{{ url_for('ajouter_intervention') }}" id="interventionForm">
            <div class="header">
                <div class="logo">
                    <!-- Logo de l'entreprise -->
                </div>
                <div class="title">
                    <h2>Ordre de travail</h2>
                    <p>Date: {{ now.strftime('%d/%m/%Y') }}</p>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Client:</div>
                    <select class="info-value form-select" id="client_id" name="client_id" required onchange="chargerVehicules(this.value)">
                        <option value="" selected disabled>Sélectionner un client</option>
                        {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.nom }} {{ client.prenom }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="info-item">
                    <div class="info-label">Véhicule:</div>
                    <div class="vehicule-search-container">
                        <input type="text" class="form-control mb-2" id="vehicule_search" placeholder="Rechercher un véhicule...">
                        <select class="info-value form-select" id="vehicule_id" name="vehicule_id" required>
                            <option value="" selected disabled>Sélectionner un véhicule</option>
                        </select>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Type d'intervention:</div>
                    <select class="info-value form-select" id="type" name="type" required>
                        <option value="Entretien">Entretien</option>
                        <option value="Réparation">Réparation</option>
                        <option value="Diagnostic">Diagnostic</option>
                    </select>
                </div>

                <div class="info-item">
                    <div class="info-label">Compteur:</div>
                    <div class="input-group">
                        <input type="number" class="info-value form-control" id="kilometrage" name="kilometrage" required>
                        <span class="input-group-text">km</span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Technicien:</div>
                    <select class="info-value form-select" id="technicien" name="technicien" required>
                        <option value="">Sélectionnez un technicien</option>
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if current_user.role != 'admin' and user.id == current_user.id %}selected{% endif %}>
                            {{ user.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="info-item">
                    <div class="info-label">Date:</div>
                    <input type="date" class="info-value form-control" id="date" name="date" value="{{ now.strftime('%Y-%m-%d') }}" required>
                </div>
            </div>

            <div class="section-header">Description des travaux</div>
            <textarea class="description-box" id="description" name="description" required></textarea>

            <div class="section-header">Pièces utilisées</div>
            <table class="pieces-table" id="pieces-table">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Quantité</th>
                        <th>Prix unitaire</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="pieces-container">
                    <!-- Les lignes de pièces seront ajoutées ici -->
                </tbody>
            </table>

            <button type="button" class="add-row-btn" onclick="ajouterPiece()">
                <i class="bi bi-plus-circle"></i> Ajouter une pièce
            </button>

            <div class="section-header">Heures de travail</div>
            <table class="signature-table">
                <thead>
                    <tr>
                        <th>Technicien</th>
                        <th>Heures réalisées</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ current_user.name }}</td>
                        <td><input type="number" name="heures" class="form-control" required></td>
                        <td>{{ now.strftime('%d/%m/%Y') }}</td>
                    </tr>
                </tbody>
            </table>

            <div class="mt-4 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i>Enregistrer l'intervention
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
    }
    .info-item {
        display: flex;
        align-items: flex-start;
    }
    .info-label {
        min-width: 180px;
        font-weight: 600;
        color: #34495e;
        padding-top: 8px;
    }
    .info-value {
        flex: 1;
    }
    .vehicule-search-container {
        flex: 1;
    }
    .vehicule-search-container input {
        margin-bottom: 8px;
        border-radius: 6px;
        border: 1px solid #e0e6ed;
    }
    .vehicule-search-container select {
        width: 100%;
    }
    .section-header {
        background: #34495e;
        color: white;
        padding: 10px 15px;
        margin: 25px 0 15px 0;
        font-weight: 500;
        border-radius: 6px;
        font-size: 14px;
        letter-spacing: 0.5px;
    }
    .description-box {
        border: 1px solid #e0e6ed;
        width: 100%;
        margin-bottom: 20px;
        padding: 8px 12px;
        border-radius: 6px;
        font-family: inherit;
        font-size: 14px;
        min-height: 100px;
        resize: vertical;
    }
    .pieces-table, .signature-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: 20px;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border-radius: 8px;
        overflow: hidden;
    }
    .pieces-table th, .signature-table th {
        background: #34495e;
        color: white;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 12px;
        padding: 12px;
        text-align: left;
    }
    .pieces-table td, .signature-table td {
        padding: 12px;
        border-top: 1px solid #e0e6ed;
    }
    .add-row-btn {
        background: #2ecc71;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.3s;
    }
    .add-row-btn:hover {
        background: #27ae60;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
let heuresModal;
let vehiculesDisponibles = [];

document.addEventListener('DOMContentLoaded', function() {
    heuresModal = new bootstrap.Modal(document.getElementById('heuresModal'));
    ajouterPiece();
});

function chargerVehicules(clientId) {
    if (!clientId) {
        document.getElementById('vehicule_id').innerHTML = '<option value="" selected disabled>Sélectionner un véhicule</option>';
        return;
    }

    fetch(`/api/vehicules_client/${clientId}`)
        .then(response => response.json())
        .then(vehicules => {
            vehiculesDisponibles = vehicules;
            afficherVehicules(vehicules);
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors du chargement des véhicules');
        });
}

function afficherVehicules(vehicules, searchTerm = '') {
    const select = document.getElementById('vehicule_id');
    select.innerHTML = '<option value="" selected disabled>Sélectionner un véhicule</option>';
    
    const filteredVehicules = searchTerm
        ? vehicules.filter(v => 
            `${v.marque} ${v.modele} ${v.immatriculation}`.toLowerCase()
            .includes(searchTerm.toLowerCase()))
        : vehicules;

    filteredVehicules.forEach(vehicule => {
        const option = document.createElement('option');
        option.value = vehicule.id;
        option.textContent = `${vehicule.marque} ${vehicule.modele} - ${vehicule.immatriculation}`;
        select.appendChild(option);
    });
}

// Gestionnaire de recherche
document.getElementById('vehicule_search').addEventListener('input', function() {
    afficherVehicules(vehiculesDisponibles, this.value);
});

function ajouterPiece() {
    const container = document.getElementById('pieces-container');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <select name="piece_id[]" class="form-select" onchange="updatePrixUnitaire(event)">
                <option value="">Sélectionner une pièce</option>
                {% for piece in stock %}
                <option value="{{ piece.id }}" data-prix="{{ piece.prix_vente }}">{{ piece.nom }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="quantite[]" class="form-control" min="1" value="1" onchange="updateTotalLigne(event)">
        </td>
        <td>
            <input type="number" class="form-control prix-unitaire" readonly>
        </td>
        <td>
            <input type="number" class="form-control total-ligne" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;
    container.appendChild(newRow);
}

function updatePrixUnitaire(event) {
    const select = event.target;
    const row = select.closest('tr');
    const option = select.selectedOptions[0];
    const prixUnitaire = option.dataset.prix || 0;
    
    const prixUnitaireInput = row.querySelector('.prix-unitaire');
    prixUnitaireInput.value = prixUnitaire;
    
    updateTotalLigne({ target: row.querySelector('input[name="quantite[]"]') });
}

function updateTotalLigne(event) {
    const input = event.target;
    const row = input.closest('tr');
    const quantite = input.value || 0;
    const prixUnitaire = row.querySelector('.prix-unitaire').value || 0;
    
    const totalInput = row.querySelector('.total-ligne');
    totalInput.value = (quantite * prixUnitaire).toFixed(2);
}
</script>
{% endblock %}
