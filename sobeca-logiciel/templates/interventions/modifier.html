{% extends 'layout.html' %}

{% block title %}Modifier l'intervention{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-tools me-2"></i>Modifier l'intervention</h1>
    <a href="{{ url_for('liste_interventions') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i>Retour à la liste
    </a>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <form method="post" action="{{ url_for('modifier_intervention', intervention_id=intervention.id) }}" id="interventionForm">
            <div class="header">
                <div class="logo">
                    <!-- Logo de l'entreprise -->
                </div>
                <div class="title">
                    <h2>Ordre de travail</h2>
                    <p>Date de création: {{ intervention.date_creation }}</p>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Client:</div>
                    <select class="info-value form-select" id="client_id" name="client_id" required>
                        <option value="" disabled>Sélectionner un client</option>
                        {% for client in clients %}
                            <option value="{{ client.id }}" {% if client.id == client_selectionne.id %}selected{% endif %}>
                                {{ client.nom }} {{ client.prenom }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="info-item">
                    <div class="info-label">Véhicule:</div>
                    <div class="vehicule-search-container">
                        <input type="text" class="form-control mb-2" id="vehicule_search" placeholder="Rechercher un véhicule...">
                        <select class="info-value form-select" id="vehicule_id" name="vehicule_id" required>
                            <option value="" disabled>Sélectionner un véhicule</option>
                            {% if vehicule_selectionne %}
                                <option value="{{ vehicule_selectionne.id }}" selected>
                                    {{ vehicule_selectionne.marque }} {{ vehicule_selectionne.modele }} ({{ vehicule_selectionne.immatriculation }})
                                </option>
                            {% endif %}
                        </select>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Type d'intervention:</div>
                    <select class="info-value form-select" id="type" name="type" required>
                        <option value="Entretien" {% if intervention.type == 'Entretien' %}selected{% endif %}>Entretien</option>
                        <option value="Réparation" {% if intervention.type == 'Réparation' %}selected{% endif %}>Réparation</option>
                        <option value="Diagnostic" {% if intervention.type == 'Diagnostic' %}selected{% endif %}>Diagnostic</option>
                    </select>
                </div>

                <div class="info-item">
                    <div class="info-label">Compteur:</div>
                    <div class="input-group">
                        <input type="number" class="info-value form-control" id="kilometrage" name="kilometrage" value="{{ intervention.kilometrage }}" required>
                        <span class="input-group-text">km</span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Technicien:</div>
                    <select class="info-value form-select" id="technicien" name="technicien" required>
                        <option value="">Sélectionnez un technicien</option>
                        {% for user in users %}
                        <option value="{{ user.username }}" {% if user.username == intervention.technicien %}selected{% endif %}>
                            {{ user.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="info-item">
                    <div class="info-label">Date:</div>
                    <input type="date" class="info-value form-control" id="date" name="date" value="{{ intervention.date }}" required>
                </div>
            </div>

            <div class="section-header">Description des travaux</div>
            <textarea class="description-box" id="description" name="description" required>{{ intervention.description }}</textarea>

            <div class="section-header">Pièces utilisées</div>
            <table class="pieces-table" id="pieces-table">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Quantité</th>
                        <th>Prix unitaire</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="pieces-container">
                    {% for piece in intervention.pieces_utilisees %}
                    <tr class="piece-row">
                        <td>{{ piece.nom }}</td>
                        <td>{{ piece.quantite }}</td>
                        <td>{{ piece.prix_unitaire }}</td>
                        <td>{{ piece.total }}</td>
                        <td>
                            <button type="button" class="delete-btn" onclick="this.closest('tr').remove()">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <button type="button" class="add-row-btn" onclick="ajouterPiece()">
                <i class="bi bi-plus-circle"></i> Ajouter une pièce
            </button>

            <div class="section-header">Heures de travail</div>
            <table class="signature-table">
                <thead>
                    <tr>
                        <th>Technicien</th>
                        <th>Heures réalisées</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ current_user.name }}</td>
                        <td><input type="number" name="heures" class="form-control" value="{{ intervention.heures }}" required></td>
                        <td>{{ now.strftime('%d/%m/%Y') }}</td>
                    </tr>
                </tbody>
            </table>

            <div class="mt-4 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i>Enregistrer les modifications
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
    }
    .info-item {
        display: flex;
        align-items: flex-start;
    }
    .info-label {
        min-width: 180px;
        font-weight: 600;
        color: #34495e;
        padding-top: 8px;
    }
    .info-value {
        flex: 1;
    }
    .vehicule-search-container {
        flex: 1;
    }
    .vehicule-search-container input {
        margin-bottom: 8px;
        border-radius: 6px;
        border: 1px solid #e0e6ed;
    }
    .vehicule-search-container select {
        width: 100%;
    }
    .section-header {
        background: #34495e;
        color: white;
        padding: 10px 15px;
        margin: 25px 0 15px 0;
        font-weight: 500;
        border-radius: 6px;
        font-size: 14px;
        letter-spacing: 0.5px;
    }
    .description-box {
        border: 1px solid #e0e6ed;
        width: 100%;
        margin-bottom: 20px;
        padding: 8px 12px;
        border-radius: 6px;
        font-family: inherit;
        font-size: 14px;
        min-height: 100px;
        resize: vertical;
    }
    .pieces-table, .signature-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: 20px;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border-radius: 8px;
        overflow: hidden;
    }
    .pieces-table th, .signature-table th {
        background: #34495e;
        color: white;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 13px;
        letter-spacing: 0.5px;
        padding: 12px 15px;
    }
    .pieces-table td, .signature-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e0e6ed;
    }
    .add-row-btn {
        background: #2ecc71;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 20px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 25px;
    }
    .add-row-btn:hover {
        background: #27ae60;
    }
    .delete-btn {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .delete-btn:hover {
        background: #c0392b;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
let vehiculesDisponibles = [];

// Mise à jour des véhicules en fonction du client sélectionné
document.getElementById('client_id').addEventListener('change', function() {
    const vehiculeSelect = document.getElementById('vehicule_id');
    const clientId = this.value;
    
    vehiculeSelect.innerHTML = '<option value="" selected disabled>Sélectionner un véhicule</option>';
    vehiculeSelect.disabled = true;
    document.getElementById('vehicule_search').value = '';
    
    if (clientId) {
        fetch(`/api/vehicules?client_id=${clientId}`)
            .then(response => response.json())
            .then(vehicules => {
                vehiculesDisponibles = vehicules;
                afficherVehicules(vehicules);
                vehiculeSelect.disabled = false;
            });
    }
});

// Fonction pour filtrer et afficher les véhicules
function afficherVehicules(vehicules, searchTerm = '') {
    const vehiculeSelect = document.getElementById('vehicule_id');
    const currentValue = vehiculeSelect.value;
    
    vehiculeSelect.innerHTML = '<option value="" disabled>Sélectionner un véhicule</option>';
    
    const filteredVehicules = vehicules.filter(vehicule => {
        const searchString = `${vehicule.marque} ${vehicule.modele} ${vehicule.immatriculation}`.toLowerCase();
        return searchString.includes(searchTerm.toLowerCase());
    });
    
    filteredVehicules.forEach(vehicule => {
        const option = document.createElement('option');
        option.value = vehicule.id;
        option.textContent = `${vehicule.marque} ${vehicule.modele} (${vehicule.immatriculation})`;
        if (vehicule.id === currentValue) {
            option.selected = true;
        }
        vehiculeSelect.appendChild(option);
    });
}

// Gestionnaire de recherche
document.getElementById('vehicule_search').addEventListener('input', function() {
    afficherVehicules(vehiculesDisponibles, this.value);
});

function ajouterPiece() {
    const container = document.getElementById('pieces-container');
    const newRow = document.createElement('tr');
    newRow.className = 'piece-row';
    newRow.innerHTML = `
        <td>
            <select class="form-select piece-select" name="piece_id[]" required>
                <option value="">Sélectionnez une pièce</option>
                {% for piece in stock %}
                <option value="{{ piece.id }}" 
                        data-prix-vente="{{ piece.prix_vente }}"
                        data-stock="{{ piece.quantite }}">
                    {{ piece.nom }} (Stock: {{ piece.quantite }})
                </option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" class="form-control piece-quantite" name="quantite[]" min="1" required>
        </td>
        <td>
            <input type="number" class="form-control prix-unitaire" readonly>
        </td>
        <td>
            <input type="number" class="form-control total-ligne" readonly>
        </td>
        <td>
            <button type="button" class="delete-btn" onclick="this.closest('tr').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;
    container.appendChild(newRow);

    // Ajouter les écouteurs d'événements pour la nouvelle ligne
    const pieceSelect = newRow.querySelector('.piece-select');
    const quantiteInput = newRow.querySelector('.piece-quantite');
    
    pieceSelect.addEventListener('change', updatePrixUnitaire);
    quantiteInput.addEventListener('input', updateTotalLigne);
}

function updatePrixUnitaire(event) {
    const select = event.target;
    const row = select.closest('tr');
    const option = select.selectedOptions[0];
    const prixVente = option.dataset.prixVente;
    
    row.querySelector('.prix-unitaire').value = prixVente;
    updateTotalLigne({ target: row.querySelector('.piece-quantite') });
}

function updateTotalLigne(event) {
    const quantiteInput = event.target;
    const row = quantiteInput.closest('tr');
    const prixUnitaire = parseFloat(row.querySelector('.prix-unitaire').value) || 0;
    const quantite = parseFloat(quantiteInput.value) || 0;
    
    row.querySelector('.total-ligne').value = (prixUnitaire * quantite).toFixed(2);
}

// Charger les véhicules du client sélectionné au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const clientId = document.getElementById('client_id').value;
    if (clientId) {
        fetch(`/api/vehicules?client_id=${clientId}`)
            .then(response => response.json())
            .then(vehicules => {
                vehiculesDisponibles = vehicules;
            });
    }
});
</script>
{% endblock %}
