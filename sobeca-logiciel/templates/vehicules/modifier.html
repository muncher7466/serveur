{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">MODIFIER LE VÉHICULE</h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('modifier_vehicule', vehicule_id=vehicule.id) }}">
                        <div class="mb-3">
                            <label for="type_vehicule" class="form-label">Type de véhicule</label>
                            <select class="form-select" id="type_vehicule" name="type_vehicule" required onchange="toggleControles()">
                                <option value="">Sélectionner un type</option>
                                <option value="voiture" {% if vehicule.type_vehicule == 'voiture' %}selected{% endif %}>Voiture</option>
                                <option value="camion" {% if vehicule.type_vehicule == 'camion' %}selected{% endif %}>Camion</option>
                                <option value="utilitaire" {% if vehicule.type_vehicule == 'utilitaire' %}selected{% endif %}>Utilitaire</option>
                                <option value="engin" {% if vehicule.type_vehicule == 'engin' %}selected{% endif %}>Engin de chantier</option>
                                <option value="remorque" {% if vehicule.type_vehicule == 'remorque' %}selected{% endif %}>Remorque</option>
                                <option value="materiel" {% if vehicule.type_vehicule == 'materiel' %}selected{% endif %}>Petit matériel</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="marque" class="form-label">Marque</label>
                                <input type="text" class="form-control" id="marque" name="marque" value="{{ vehicule.marque }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="modele" class="form-label">Modèle</label>
                                <input type="text" class="form-control" id="modele" name="modele" value="{{ vehicule.modele }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="annee" class="form-label">Année</label>
                                <input type="number" class="form-control" id="annee" name="annee" min="1900" max="2099" value="{{ vehicule.annee }}" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="immatriculation" class="form-label">Immatriculation</label>
                            <input type="text" class="form-control" id="immatriculation" name="immatriculation" value="{{ vehicule.immatriculation }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="kilometrage" class="form-label">Compteur</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="kilometrage" name="kilometrage" min="0" value="{{ vehicule.kilometrage }}" required>
                                <span class="input-group-text">km</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="code_parc" class="form-label">Code Parc</label>
                            <input type="text" class="form-control" id="code_parc" name="code_parc" value="{{ vehicule.code_parc }}">
                        </div>

                        <div class="mb-3">
                            <label for="numero_serie" class="form-label">Numéro de série</label>
                            <input type="text" class="form-control" id="numero_serie" name="numero_serie" value="{{ vehicule.numero_serie }}">
                        </div>

                        <div class="mb-3">
                            <label for="client" class="form-label">Client</label>
                            <select class="form-select" id="client" name="client_id">
                                <option value="">Sélectionner un client</option>
                                {% for client in clients %}
                                <option value="{{ client.id }}" {% if client.id == vehicule.client_id %}selected{% endif %}>
                                    {{ client.nom }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Contrôles spécifiques -->
                        <div id="controles">
                            <h4 class="mt-4 mb-3">Dates des derniers contrôles</h4>
                            
                            <div id="ct_block" style="display: none;">
                                <div class="mb-3">
                                    <label for="date_dernier_ct" class="form-label">Date du dernier contrôle technique</label>
                                    <input type="date" class="form-control" id="date_dernier_ct" name="date_dernier_ct" 
                                           value="{{ vehicule.date_dernier_ct if vehicule.date_dernier_ct }}">
                                </div>
                            </div>

                            <div id="mine_block" style="display: none;">
                                <div class="mb-3">
                                    <label for="date_dernier_mine" class="form-label">Date du dernier contrôle des mines</label>
                                    <input type="date" class="form-control" id="date_dernier_mine" name="date_dernier_mine"
                                           value="{{ vehicule.date_dernier_mine if vehicule.date_dernier_mine }}">
                                </div>
                            </div>

                            <div id="tachy_block" style="display: none;">
                                <div class="mb-3">
                                    <label for="date_dernier_tachy" class="form-label">Date du dernier contrôle tachygraphe</label>
                                    <input type="date" class="form-control" id="date_dernier_tachy" name="date_dernier_tachy"
                                           value="{{ vehicule.date_dernier_tachy if vehicule.date_dernier_tachy }}">
                                </div>
                            </div>

                            <div id="vgp_block" style="display: none;">
                                <div class="mb-3">
                                    <label for="date_dernier_vgp" class="form-label">Date de la dernière VGP</label>
                                    <input type="date" class="form-control" id="date_dernier_vgp" name="date_dernier_vgp"
                                           value="{{ vehicule.date_dernier_vgp if vehicule.date_dernier_vgp }}">
                                </div>
                            </div>
                        </div>

                        <div class="text-end">
                            <a href="{{ url_for('liste_vehicules') }}" class="btn btn-secondary me-2">ANNULER</a>
                            <button type="submit" class="btn btn-primary">ENREGISTRER</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleControles() {
    const typeVehicule = document.getElementById('type_vehicule').value;
    const controlesDiv = document.getElementById('controles');
    const ctBlock = document.getElementById('ct_block');
    const mineBlock = document.getElementById('mine_block');
    const tachyBlock = document.getElementById('tachy_block');
    const vgpBlock = document.getElementById('vgp_block');
    
    // Réinitialiser tous les champs
    ctBlock.style.display = 'none';
    mineBlock.style.display = 'none';
    tachyBlock.style.display = 'none';
    vgpBlock.style.display = 'none';
    
    // Masquer complètement la section des contrôles pour remorque et petit matériel
    if (typeVehicule === 'remorque' || typeVehicule === 'materiel') {
        controlesDiv.style.display = 'none';
        return;
    }
    
    // Afficher la section des contrôles pour les autres types
    controlesDiv.style.display = 'block';
    
    // Afficher les contrôles appropriés selon le type
    switch(typeVehicule) {
        case 'voiture':
            ctBlock.style.display = 'block';
            break;
        case 'camion':
            ctBlock.style.display = 'block';
            mineBlock.style.display = 'block';
            tachyBlock.style.display = 'block';
            break;
        case 'utilitaire':
            ctBlock.style.display = 'block';
            break;
        case 'engin':
            vgpBlock.style.display = 'block';
            break;
    }
}

// Appeler toggleControles au chargement de la page
document.addEventListener('DOMContentLoaded', toggleControles);
</script>
{% endblock %}
